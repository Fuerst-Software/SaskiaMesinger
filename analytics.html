<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics – Saskia Mesinger</title>

  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#020308;
      --navy-soft:#040711;

      --gold:#d4a436;
      --gold-soft:#f1c75c;
      --gold-strong:#ffd979;

      --text-strong:#f7f2eb;
      --text-soft:#cfc6bb;
      --text-muted:#8b847c;

      --radius-lg:26px;
      --radius-md:18px;

      --shadow-deep:0 40px 100px rgba(0,0,0,.92);
      --shadow-soft:0 22px 60px rgba(0,0,0,.82);

      --transition-fast:150ms ease-out;
      --transition-med:260ms ease-out;

      --header-h:78px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      background: radial-gradient(circle at top, #070a12 0%, #02030a 55%, #010107 100%);
      color:var(--text-strong);
      font-family:"Inter",system-ui,-apple-system,"Segoe UI",sans-serif;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }
    body{ scrollbar-width:none; -ms-overflow-style:none; }
    body::-webkit-scrollbar{ width:0; height:0; }

    h1,h2,h3{ font-family:"Cormorant Garamond","Times New Roman",serif; }

    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:999;
      background: linear-gradient(to bottom, rgba(1,2,6,.96), rgba(1,2,6,.985));
      border-bottom:1px solid rgba(255,211,106,.22);
      box-shadow:0 18px 40px rgba(0,0,0,.9);
      backdrop-filter: blur(10px);
    }
    .lux-header-inner{
      max-width:1480px; margin:0 auto;
      height:var(--header-h);
      padding:0 40px;
      display:flex; align-items:center; justify-content:space-between;
      gap:18px;
    }
    .lux-brand{ display:flex; flex-direction:column; line-height:1.1; }
    .lux-brand-top{
      letter-spacing:.32em; font-size:1rem; color:var(--gold-strong);
    }
    .lux-brand-sub{
      letter-spacing:.28em; font-size:.72rem; color:var(--text-muted);
      text-transform:uppercase;
    }

    .btn{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 18px;
      font-size:.74rem; letter-spacing:.18em; text-transform:uppercase;
      color:#fdf5ee;
      border-radius:999px;
      border:1px solid rgba(255,211,106,.68);
      cursor:pointer;
      background:
        linear-gradient(145deg, rgba(0,0,0,.5), rgba(0,0,0,.9)),
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 55%);
      box-shadow:0 14px 30px rgba(0,0,0,.75);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast), border-color var(--transition-fast);
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow:0 20px 38px rgba(0,0,0,.9);
      border-color: var(--gold-strong);
      filter: brightness(1.04);
    }
    .btn--ghost{
      background: rgba(8,10,14,.35);
      border-color: rgba(255,211,106,.35);
    }

    .page{
      max-width:1280px;
      margin:0 auto;
      padding: var(--header-h) 32px 64px;
    }

    .hero{
      padding: 26px 0 22px;
      text-align:center;
    }
    .hero h1{
      margin:0;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-weight:600;
      font-size: clamp(2.2rem, 5.5vw, 3.6rem);
      background: linear-gradient(180deg,#fff4cc 0%,#ffd36a 28%,#f0b93a 55%,#c98e14 78%,#ffe7a8 100%);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow: 0 0 10px rgba(255,211,106,.12), 0 0 22px rgba(255,211,106,.10);
    }
    .hero p{
      margin:10px auto 0;
      max-width:700px;
      color:var(--text-soft);
      opacity:.95;
      letter-spacing:.06em;
    }

    .panel{
      margin: 18px auto 0;
      max-width: 980px;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.16);
      background:
        linear-gradient(140deg, rgba(0,0,0,.62), rgba(0,0,0,.92)),
        radial-gradient(circle at 0 0, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(circle at 100% 120%, rgba(0,0,0,.6), transparent 55%);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .panel__inner{ padding: 22px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
    }
    @media (max-width: 900px){
      .lux-header-inner{ padding:0 18px; }
      .page{ padding: var(--header-h) 18px 44px; }
      .grid{ grid-template-columns: 1fr; }
    }

    .field{ display:grid; gap:6px; text-align:left; }
    .label{
      font-size:.76rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:var(--text-muted);
    }
    .input{
      font-family:inherit;
      font-size:.92rem;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.22);
      padding:10px;
      background: rgba(5,6,10,.86);
      color:var(--text-strong);
    }
    .input:focus{
      outline:none;
      border-color: rgba(255,211,106,.95);
      box-shadow: 0 0 0 1px rgba(255,211,106,.55);
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 900px){ .kpis{ grid-template-columns: 1fr; } }

    .kpi{
      border-radius:18px;
      border:1px solid rgba(255,211,106,.22);
      background: rgba(2,3,8,.35);
      padding:16px;
      box-shadow: 0 16px 34px rgba(0,0,0,.65);
    }
    .kpi .kpi__label{
      font-size:.72rem;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:var(--text-muted);
    }
    .kpi .kpi__value{
      margin-top:6px;
      font-family:"Cormorant Garamond","Times New Roman",serif;
      font-size:2.2rem;
      letter-spacing:.08em;
      color:var(--gold-strong);
    }

    .tableWrap{
      margin-top:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background: rgba(2,3,8,.28);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    thead th{
      text-align:left;
      padding:12px 12px;
      font-size:.72rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:var(--text-muted);
      background: rgba(0,0,0,.35);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:var(--text-soft);
    }
    tbody tr:hover td{
      background: rgba(255,211,106,.05);
      color: var(--text-strong);
    }

    .msg{
      margin: 10px 0 0;
      font-size:.86rem;
      color: rgba(255,160,160,.95);
      min-height: 1.2em;
      text-align:left;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .muted{ color:var(--text-muted); font-size:.86rem; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <header class="site-header" role="banner">
    <div class="lux-header-inner">
      <div class="lux-brand">
        <span class="lux-brand-top">Saskia Mesinger</span>
        <span class="lux-brand-sub">Analytics</span>
      </div>

      <div class="topbar">
        <span class="muted" id="statusText">Nicht angemeldet</span>
        <button class="btn btn--ghost hidden" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <div class="page">
    <section class="hero">
      <h1>Analytics</h1>
      <p>Interne Auswertung (Pageviews &amp; Cookie-Accepts) – gesichert per Login und gespeist durch Cloudflare Worker + KV.</p>
    </section>

    <!-- LOGIN -->
    <section class="panel" id="loginPanel">
      <div class="panel__inner">
        <h2 style="margin:0 0 8px; letter-spacing:.08em;">Login</h2>
        <p class="muted" style="margin:0 0 14px;">Nur für interne Nutzung. Zugangsdaten sind erforderlich.</p>

        <div class="grid">
          <div class="field">
            <span class="label">Benutzername</span>
            <input class="input" id="username" autocomplete="username" value="saskia" />
          </div>
          <div class="field">
            <span class="label">Passwort</span>
            <input class="input" id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="loginBtn" type="button">Einloggen</button>
        </div>

        <div class="msg" id="loginMsg"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section class="panel hidden" id="dashPanel" style="margin-top:18px;">
      <div class="panel__inner">
        <div class="topbar">
          <h2 style="margin:0; letter-spacing:.08em;">Dashboard</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn--ghost" id="refreshBtn" type="button">Refresh</button>
          </div>
        </div>
        <p class="muted" style="margin:10px 0 0;">Quelle: <span id="apiBase"></span></p>

        <div class="kpis">
          <div class="kpi">
            <div class="kpi__label">Pageviews</div>
            <div class="kpi__value" id="kpiPageviews">—</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Cookie Accepts</div>
            <div class="kpi__value" id="kpiAccepts">—</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Events (letzte 200)</div>
            <div class="kpi__value" id="kpiEvents">—</div>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Zeit</th>
                <th>Typ</th>
                <th>Seite</th>
              </tr>
            </thead>
            <tbody id="eventsBody">
              <tr><td colspan="3" class="muted" style="padding:14px 12px;">Noch keine Daten.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="msg" id="dashMsg" style="color:rgba(255,211,106,.9)"></div>
      </div>
    </section>
  </div>

  <script>
    (() => {
      "use strict";

      const API_BASE = "https://saskia-analytics-api.florianfloki1.workers.dev";
      const TOKEN_KEY = "SM_ANALYTICS_TOKEN_V1";

      const $ = (id) => document.getElementById(id);

      const loginPanel = $("loginPanel");
      const dashPanel  = $("dashPanel");
      const loginMsg   = $("loginMsg");
      const dashMsg    = $("dashMsg");
      const statusText = $("statusText");
      const logoutBtn  = $("logoutBtn");

      $("apiBase").textContent = API_BASE;

      const setStatus = (txt) => statusText.textContent = txt;

      const getToken = () => sessionStorage.getItem(TOKEN_KEY) || "";
      const setToken = (t) => sessionStorage.setItem(TOKEN_KEY, t);
      const clearToken = () => sessionStorage.removeItem(TOKEN_KEY);

      const showDash = () => {
        loginPanel.classList.add("hidden");
        dashPanel.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
      };

      const showLogin = () => {
        dashPanel.classList.add("hidden");
        loginPanel.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      };

      const fmtTime = (iso) => {
        try {
          const d = new Date(iso);
          return d.toLocaleString("de-DE");
        } catch { return iso; }
      };

      const renderEvents = (events) => {
        const tbody = $("eventsBody");
        tbody.innerHTML = "";

        if (!events || !events.length) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px 12px;">Noch keine Daten.</td></tr>`;
          return;
        }

        const rows = events.slice().reverse().map(e => `
          <tr>
            <td>${fmtTime(e.t)}</td>
            <td>${(e.type || "").toUpperCase()}</td>
            <td>${e.page || "/"}</td>
          </tr>
        `).join("");

        tbody.innerHTML = rows;
      };

      const fetchStats = async () => {
        dashMsg.textContent = "";
        const token = getToken();
        if (!token) {
          showLogin();
          setStatus("Nicht angemeldet");
          return;
        }

        const res = await fetch(`${API_BASE}/stats`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.status === 401) {
          clearToken();
          showLogin();
          setStatus("Session abgelaufen");
          loginMsg.textContent = "Session abgelaufen – bitte neu einloggen.";
          return;
        }

        const data = await res.json();
        $("kpiPageviews").textContent = String(data.pageviews ?? 0);
        $("kpiAccepts").textContent   = String(data.accepts ?? 0);
        $("kpiEvents").textContent    = String((data.events || []).length);

        renderEvents(data.events || []);
        setStatus("Angemeldet");
        dashMsg.textContent = "Live – Daten aus KV geladen.";
      };

      const doLogin = async () => {
        loginMsg.textContent = "";
        const username = $("username").value.trim();
        const password = $("password").value;

        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          loginMsg.textContent = "Login fehlgeschlagen.";
          return;
        }

        const data = await res.json();
        if (!data.token) {
          loginMsg.textContent = "Login fehlgeschlagen (kein Token).";
          return;
        }

        setToken(data.token);
        showDash();
        setStatus("Angemeldet");
        await fetchStats();
      };

      $("loginBtn").addEventListener("click", doLogin);
      $("refreshBtn").addEventListener("click", fetchStats);
      logoutBtn.addEventListener("click", () => {
        clearToken();
        showLogin();
        setStatus("Nicht angemeldet");
        $("password").value = "";
      });

      // Auto-Load wenn Token schon da ist
      if (getToken()) {
        showDash();
        fetchStats();
      }
    })();
  </script>
  <script src="cookies.js"></script>
</body>
</html>
